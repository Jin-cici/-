<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ—¥ç¨‹ç®¡ç† - Morandi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* åŸºç¡€é…è‰²ï¼ˆè«å…°è¿ªï¼‰ */
    :root {
      --mint: #C1D2C1;
      --cream: #DBCAB5;
      --mauve: #DFD6DB;
      --blue: #ADC4D4;
      --red: #E2A6A1;
      --ink: #2F2F2F;
      --bg: #F7F5F2;
      --app-bg: radial-gradient(circle at 20% 20%, #F1EEE9 0%, var(--bg) 60%),
                radial-gradient(circle at 80% 0%, #ECE6E1 0%, var(--bg) 55%);
    }

    body {
      font-family: "Playfair Display", "Georgia", serif;
      color: var(--ink);
      background: var(--app-bg);
      transition: background 0.5s ease;
    }

    button,
    .tab-btn {
      min-height: 44px;
      min-width: 44px;
    }

    .soft-card {
      box-shadow: 0 10px 28px rgba(35, 35, 35, 0.08);
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(47, 47, 47, 0.08);
      border-radius: 16px;
      padding: 16px;
    }

    .timeline-line {
      position: absolute;
      left: 14px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(47, 47, 47, 0.15);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--blue);
    }

    .hand-drawn {
      font-family: "Caveat", "Comic Sans MS", cursive;
    }

    .journal-hand {
      font-family: "Kalam", "Caveat", "Comic Sans MS", cursive;
      letter-spacing: 0.04em;
    }

    .tab-btn.active {
      background: var(--cream);
    }

    .project-item:hover .project-delete,
    .task-card:hover .task-delete {
      opacity: 1;
    }

    .editable {
      cursor: text;
    }

    /* ç”µå­æ—¥è®°ï¼šæ‚å¿—å¼ç€‘å¸ƒæµå¸ƒå±€ */
    #journal {
      position: relative;
      overflow: hidden;
    }

    #journal::before {
      content: "";
      position: absolute;
      inset: -20% -10% auto -10%;
      height: 120%;
      background:
        radial-gradient(200px 160px at 18% 20%, rgba(173, 196, 212, 0.35), transparent 70%),
        radial-gradient(220px 180px at 70% 10%, rgba(223, 214, 219, 0.4), transparent 70%),
        radial-gradient(260px 220px at 30% 70%, rgba(219, 202, 181, 0.35), transparent 72%),
        radial-gradient(240px 200px at 80% 78%, rgba(193, 210, 193, 0.32), transparent 70%);
      filter: blur(18px);
      opacity: 0.9;
      pointer-events: none;
      z-index: 0;
    }

    #journal::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(0deg, rgba(47, 47, 47, 0.03) 0, rgba(47, 47, 47, 0.03) 1px, transparent 1px, transparent 14px),
        repeating-linear-gradient(90deg, rgba(47, 47, 47, 0.02) 0, rgba(47, 47, 47, 0.02) 1px, transparent 1px, transparent 14px);
      opacity: 0.35;
      pointer-events: none;
      z-index: 0;
    }

    .journal-decor {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    .decor-line {
      position: absolute;
      top: 14px;
      right: 28px;
      width: 120px;
      height: 1px;
      background: rgba(47, 47, 47, 0.25);
      transform: rotate(-6deg);
    }

    .decor-dots {
      position: absolute;
      bottom: 18px;
      left: 24px;
      width: 54px;
      height: 16px;
      background:
        radial-gradient(circle, rgba(47, 47, 47, 0.35) 2px, transparent 3px) 0 0 / 12px 12px,
        radial-gradient(circle, rgba(47, 47, 47, 0.25) 2px, transparent 3px) 6px 6px / 12px 12px;
      opacity: 0.6;
    }

    .decor-date {
      position: absolute;
      top: 40px;
      left: 20px;
      font-size: 12px;
      letter-spacing: 0.5em;
      color: rgba(47, 47, 47, 0.35);
      transform: rotate(-2deg);
    }

    .journal-grid {
      column-count: 1;
      column-gap: 18px;
      position: relative;
      z-index: 2;
    }

    @media (min-width: 768px) {
      .journal-grid {
        column-count: 2;
      }
    }

    @media (min-width: 1024px) {
      .journal-grid {
        column-count: 3;
      }
    }

    .journal-card {
      break-inside: avoid;
      margin-bottom: 18px;
      border-radius: 22px 16px 24px 14px;
      border: 2px dashed rgba(47, 47, 47, 0.2);
      background: #fff;
      position: relative;
      padding: 20px 18px 18px;
      box-shadow: 0 18px 36px rgba(35, 35, 35, 0.12);
    }

    /* éå¯¹ç§°å¾®æ—‹è½¬ï¼Œè¥é€ æ‚å¿—æ‹¼è´´æ„Ÿ */
    .journal-card:nth-child(3n + 1) { transform: rotate(-0.8deg); }
    .journal-card:nth-child(3n + 2) { transform: rotate(0.9deg); }
    .journal-card:nth-child(3n + 3) { transform: rotate(-0.3deg); }

    .journal-card::after {
      content: "";
      position: absolute;
      inset: 10px;
      border: 2px solid rgba(47, 47, 47, 0.08);
      border-radius: 18px 12px 20px 14px;
      pointer-events: none;
    }

    /* å¤ç›˜åŒºåŸŸï¼šæ²¹ç”»æ„Ÿå åŠ  */
    .ornate-frame {
      position: relative;
      padding: 16px 16px 14px;
      border-radius: 18px 12px 20px 14px;
      background: #fff;
      border: 2px solid rgba(47, 47, 47, 0.16);
      box-shadow: inset 0 0 0 2px rgba(173, 196, 212, 0.25);
      overflow: hidden;
    }

    .ornate-frame::before {
      content: "";
      position: absolute;
      inset: -10px;
      background:
        radial-gradient(120px 90px at 15% 20%, rgba(173, 196, 212, 0.55), transparent 70%),
        radial-gradient(140px 110px at 80% 25%, rgba(223, 214, 219, 0.6), transparent 72%),
        radial-gradient(160px 120px at 30% 85%, rgba(219, 202, 181, 0.55), transparent 75%),
        radial-gradient(140px 120px at 85% 80%, rgba(193, 210, 193, 0.5), transparent 70%);
      filter: blur(14px);
      opacity: 0.9;
      pointer-events: none;
    }

    /* çº¸å¼ è´¨æ„Ÿä¸æ·¡æ·¡ç½‘æ ¼çº¹ */
    .ornate-frame::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(0deg, rgba(47, 47, 47, 0.04) 0, rgba(47, 47, 47, 0.04) 1px, transparent 1px, transparent 12px),
        repeating-linear-gradient(90deg, rgba(47, 47, 47, 0.035) 0, rgba(47, 47, 47, 0.035) 1px, transparent 1px, transparent 12px);
      opacity: 0.5;
      pointer-events: none;
      mix-blend-mode: multiply;
    }

    .doodle-line {
      height: 2px;
      background: repeating-linear-gradient(90deg, rgba(47, 47, 47, 0.4), rgba(47, 47, 47, 0.4) 6px, transparent 6px, transparent 10px);
    }

    /* æ—¥æœŸåœ†å½¢æˆ³ï¼ˆè£…é¥°ï¼‰ */
    .date-badge {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 2px solid rgba(47, 47, 47, 0.25);
      display: grid;
      place-items: center;
      font-size: 12px;
      color: rgba(47, 47, 47, 0.7);
      transform: rotate(-6deg);
      background: var(--mauve);
    }

    .quote-editable {
      cursor: text;
    }

    /* æ—¥å†åœ†ç‚¹ */
    .cal-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      display: inline-block;
    }

    /* æ—¶é—´è½´æˆªæ­¢æ—¥æœŸå¼ºè°ƒ */
    .deadline-text {
      color: var(--blue);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .deadline-input {
      border: 1px solid rgba(47, 47, 47, 0.18);
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 12px;
      background: #fff;
    }

    /* èƒŒæ™¯é€‰æ‹©æµ®çª— */
    .bg-panel {
      position: absolute;
      top: 42px;
      left: 0;
      width: 220px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(47, 47, 47, 0.12);
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.12);
      padding: 10px;
      z-index: 50;
      display: none;
    }

    .bg-panel.show {
      display: block;
    }

    .bg-swatch {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(47, 47, 47, 0.12);
      cursor: pointer;
    }

    .bg-label {
      font-size: 12px;
      color: rgba(47, 47, 47, 0.7);
      margin: 6px 0 4px;
    }

    .bg-input {
      width: 100%;
      border: 1px solid rgba(47, 47, 47, 0.16);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      background: #fff;
    }

    /* ç§»åŠ¨ç«¯ä¾§è¾¹æ  */
    .sidebar {
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 260px;
        transform: translateX(-100%);
        z-index: 60;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 55;
        display: none;
      }

      .overlay.show {
        display: block;
      }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Caveat:wght@500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">
  <div id="overlay" class="overlay"></div>
  <div class="grid min-h-screen" style="grid-template-columns: 260px 1fr;">
    <aside id="sidebar" class="sidebar p-5 border-r border-black/5 relative" style="background: var(--mauve);">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-semibold tracking-wide">æˆ‘çš„é¡¹ç›®</div>
        <button id="bgToggle" class="w-8 h-8 rounded-full bg-white/70 border border-black/10 flex items-center justify-center" title="è‡ªå®šä¹‰èƒŒæ™¯">ğŸ¨</button>
      </div>
      <div id="bgPanel" class="bg-panel">
        <div class="bg-label">è«å…°è¿ªçº¯è‰²</div>
        <div class="flex items-center gap-2 mb-2">
          <button class="bg-swatch" data-bg="solid" data-value="#F4F1ED" style="background:#F4F1ED"></button>
          <button class="bg-swatch" data-bg="solid" data-value="#F0E6E0" style="background:#F0E6E0"></button>
          <button class="bg-swatch" data-bg="solid" data-value="#E9EEF0" style="background:#E9EEF0"></button>
          <button class="bg-swatch" data-bg="solid" data-value="#EFE9F1" style="background:#EFE9F1"></button>
        </div>
        <div class="bg-label">è‰ºæœ¯æ¸å˜</div>
        <button id="bgArt" class="w-full rounded-lg px-2 py-1 text-xs font-semibold" style="background: var(--blue);">åº”ç”¨è‰ºæœ¯æ¸å˜</button>
        <div class="bg-label">è‡ªå®šä¹‰å›¾ç‰‡</div>
        <input id="bgFile" class="bg-input" type="file" accept="image/*" />
      </div>
      <ul id="projectList" class="space-y-2 mb-4"></ul>
      <button id="addProjectBtn" class="w-full rounded-lg px-3 py-2 font-semibold text-sm" style="background: var(--blue);">æ–°å¢é¡¹ç›®</button>
    </aside>

    <main class="p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <button id="menuToggle" class="md:hidden w-10 h-10 rounded-lg border border-black/10 bg-white/70">â‰¡</button>
          <div id="projectTitle" class="text-2xl font-semibold">æˆ‘çš„é¡¹ç›®</div>
        </div>
        <div class="flex gap-2">
          <button class="tab-btn active rounded-full border border-black/10 px-4 py-2 text-sm" data-tab="timeline">æ—¶é—´è½´</button>
          <button class="tab-btn rounded-full border border-black/10 px-4 py-2 text-sm" data-tab="calendar">æœˆè§†å›¾</button>
          <button class="tab-btn rounded-full border border-black/10 px-4 py-2 text-sm" data-tab="journal">ç”µå­æ—¥è®°</button>
        </div>
      </div>

      <section id="timeline" class="panel glass-panel">
        <div id="timelineBody" class="relative pl-8"></div>
        <button id="addTaskBtn" class="mt-4 rounded-lg px-4 py-2 text-sm font-semibold" style="background: var(--cream);">æ–°å¢ä»»åŠ¡</button>
      </section>

      <section id="calendar" class="panel hidden glass-panel">
        <div class="rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <button id="prevMonth" class="rounded-lg px-3 py-2 text-sm font-semibold" style="background: var(--blue);">ä¸Šä¸ªæœˆ</button>
            <div id="calTitle" class="font-semibold"></div>
            <button id="nextMonth" class="rounded-lg px-3 py-2 text-sm font-semibold" style="background: var(--blue);">ä¸‹ä¸ªæœˆ</button>
          </div>
          <div class="grid grid-cols-7 gap-2 text-xs" id="calGrid"></div>
        </div>
      </section>

      <section id="journal" class="panel hidden glass-panel">
        <div class="journal-decor">
          <div class="decor-line"></div>
          <div class="decor-dots"></div>
          <div class="decor-date">DATE</div>
        </div>
        <div class="journal-grid" id="journalGrid"></div>
      </section>
    </main>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    const state = {
      projects: [
        {
          id: "p1",
          name: "æˆ‘çš„é¡¹ç›® 1",
          tasks: [
            { id: "t1", title: "æäº¤å‘¨æŠ¥", deadline: "2026-03-02", remark: "æ±‡æ€»å…³é”®è¿›åº¦", review: "", quote: "æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½ç®—æ•°", done: false },
            { id: "t2", title: "å¤ç›˜ä¼šè®®", deadline: "2026-03-05", remark: "å‡†å¤‡è®®ç¨‹", review: "èŠ‚å¥ä¸é”™ï¼›ä¸‹æ¬¡è¯·æ›´æ¸…æ™°åœ°æ€»ç»“ç»“è®ºã€‚", quote: "ç¨³ä½èŠ‚å¥ï¼Œç¨³ä½å¿ƒæ€", done: true },
            { id: "t3", title: "å­¦ä¹ å†²åˆº", deadline: "2026-03-10", remark: "å®Œæˆç¬¬ 3 ç« ", review: "", quote: "ç»§ç»­å‰è¿›ï¼Œä¿æŒä¸“æ³¨", done: false }
          ]
        },
        {
          id: "p2",
          name: "äº§å“è¿­ä»£",
          tasks: [
            { id: "t4", title: "ç”¨æˆ·è®¿è°ˆ", deadline: "2026-03-01", remark: "è®¿è°ˆ 5 ä½ç”¨æˆ·", review: "æ´å¯Ÿé›†ä¸­åœ¨é€Ÿåº¦ä¸æ¸…æ™°åº¦ã€‚", quote: "å€¾å¬æ˜¯æœ€å¥½çš„å¼€å§‹", done: true },
            { id: "t5", title: "æ–¹æ¡ˆè¯„å®¡", deadline: "2026-03-07", remark: "å‡†å¤‡å¯è§†åŒ–è®²è§£", review: "", quote: "ç»†èŠ‚ä¼šè¯´è¯", done: false }
          ]
        }
      ],
      currentProjectId: "p1",
      currentTab: "timeline",
      monthOffset: 0,
      isRenaming: false
    };

    const STORAGE_KEY = "morandi_schedule_state_v1";
    const BG_KEY = "morandi_schedule_bg_v1";
    const $ = (sel) => document.querySelector(sel);

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.projects) {
          state.projects = parsed.projects;
          state.currentProjectId = parsed.currentProjectId || state.projects[0]?.id || "p1";
          state.monthOffset = parsed.monthOffset || 0;
        }
      } catch (err) {
        // å¿½ç•¥æŸåæ•°æ®
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        projects: state.projects,
        currentProjectId: state.currentProjectId,
        monthOffset: state.monthOffset
      }));
    }

    function loadBackground() {
      const bg = localStorage.getItem(BG_KEY);
      if (bg) applyBackground(bg, false);
    }

    function saveBackground(value) {
      localStorage.setItem(BG_KEY, value);
    }

    function todayISO() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function getProject() {
      return state.projects.find(p => p.id === state.currentProjectId);
    }

    function sortTasks(tasks) {
      return [...tasks].sort((a, b) => a.deadline.localeCompare(b.deadline));
    }

    function statusColor(task) {
      const overdue = !task.done && todayISO() > task.deadline;
      if (overdue) return "var(--red)";
      if (task.done) return "var(--mint)";
      return "var(--cream)";
    }

    // èƒŒæ™¯åˆ‡æ¢
    function applyBackground(value, persist = true) {
      document.documentElement.style.setProperty("--app-bg", value);
      if (persist) saveBackground(value);
    }

    // é€šç”¨å¯ç¼–è¾‘æ ‡é¢˜ï¼ˆæ”¯æŒç‚¹å‡»æˆ–åŒå‡»è§¦å‘ï¼‰
    function makeEditable(element, initialValue, onSave, trigger = "click") {
      element.classList.add("editable");
      const startEdit = (e) => {
        if (e) e.stopPropagation();
        state.isRenaming = true;

        const input = document.createElement("input");
        input.type = "text";
        input.value = initialValue();
        input.className = "w-full rounded-lg border border-black/10 px-2 py-1 text-sm bg-white";
        element.replaceWith(input);
        input.focus();
        input.select();

        const save = () => {
          const nextValue = input.value.trim();
          if (nextValue) onSave(nextValue);
          state.isRenaming = false;
          renderAll();
        };

        input.onblur = save;
        input.onkeydown = (evt) => {
          if (evt.key === "Enter") save();
        };
      };

      if (trigger === "dblclick") {
        element.ondblclick = startEdit;
      } else {
        element.onclick = startEdit;
      }
    }

    // æˆªæ­¢æ—¥æœŸå¯ç¼–è¾‘
    function makeDateEditable(element, task) {
      element.onclick = (e) => {
        e.stopPropagation();
        const input = document.createElement("input");
        input.type = "date";
        input.value = task.deadline;
        input.className = "deadline-input";
        element.replaceWith(input);
        input.focus();

        const save = () => {
          if (input.value) task.deadline = input.value;
          renderAll();
        };

        input.onblur = save;
        input.onkeydown = (evt) => {
          if (evt.key === "Enter") save();
        };
      };
    }

    function closeSidebar() {
      const sidebar = $("#sidebar");
      const overlay = $("#overlay");
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
    }

    function renderProjects() {
      const list = $("#projectList");
      list.innerHTML = "";
      state.projects.forEach(p => {
        const li = document.createElement("li");
        li.className = "project-item rounded-lg px-3 py-2 cursor-pointer transition flex items-center justify-between gap-2" + (p.id === state.currentProjectId ? " translate-x-1" : "");
        li.style.background = p.id === state.currentProjectId ? "var(--cream)" : "rgba(255,255,255,0.6)";

        // å•å‡»åˆ‡æ¢é¡¹ç›®
        li.onclick = () => {
          if (state.isRenaming) return;
          state.currentProjectId = p.id;
          renderAll();
          closeSidebar();
        };

        const name = document.createElement("div");
        name.className = "flex-1 text-sm";
        name.textContent = p.name;
        // åŒå‡»è¿›å…¥é‡å‘½å
        makeEditable(name, () => p.name, (value) => p.name = value, "dblclick");

        const del = document.createElement("button");
        del.className = "project-delete text-xs opacity-60 hover:opacity-100 transition";
        del.textContent = "âœ•";
        del.onclick = (e) => {
          e.stopPropagation();
          state.projects = state.projects.filter(item => item.id !== p.id);
          if (state.projects.length === 0) {
            state.projects.push({ id: "p" + Math.random().toString(36).slice(2, 8), name: "æˆ‘çš„é¡¹ç›®", tasks: [] });
          }
          state.currentProjectId = state.projects[0].id;
          renderAll();
        };

        li.appendChild(name);
        li.appendChild(del);
        list.appendChild(li);
      });
      $("#projectTitle").textContent = getProject().name;
    }

    function renderTimeline() {
      const body = $("#timelineBody");
      body.innerHTML = "";
      const tasks = sortTasks(getProject().tasks);

      if (tasks.length === 0) {
        body.innerHTML = '<div class="text-sm text-black/50">æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»â€œæ–°å¢ä»»åŠ¡â€å¼€å§‹ã€‚</div>';
        return;
      }

      const line = document.createElement("div");
      line.className = "timeline-line";
      body.appendChild(line);

      tasks.forEach((task, idx) => {
        const card = document.createElement("div");
        card.className = "task-card relative rounded-lg p-4 mb-4 soft-card";
        card.style.background = task.done ? "var(--mint)" : (todayISO() > task.deadline ? "var(--red)" : "#fff");

        const dot = document.createElement("div");
        dot.className = "dot absolute";
        dot.style.left = "-23px";
        dot.style.top = "18px";
        dot.style.boxShadow = "0 0 0 2px #fff, 0 0 0 4px rgba(47,47,47,0.08)";
        card.appendChild(dot);

        const header = document.createElement("div");
        header.className = "flex items-center justify-between gap-3";

        const title = document.createElement("div");
        title.className = "font-semibold";
        title.textContent = task.title;
        makeEditable(title, () => task.title, (value) => task.title = value, "click");

        const meta = document.createElement("div");
        meta.className = "deadline-text text-xs";
        meta.textContent = `æˆªæ­¢æ—¥æœŸï¼š${task.deadline}`;
        makeDateEditable(meta, task);

        const right = document.createElement("div");
        right.className = "flex items-center gap-2";

        const check = document.createElement("input");
        check.type = "checkbox";
        check.checked = task.done;
        check.onchange = () => {
          task.done = check.checked;
          renderAll();
        };

        const del = document.createElement("button");
        del.className = "task-delete text-xs opacity-60 hover:opacity-100 transition";
        del.textContent = "ğŸ—‘";
        del.onclick = () => {
          getProject().tasks = getProject().tasks.filter(item => item.id !== task.id);
          renderAll();
        };

        right.appendChild(check);
        right.appendChild(del);

        header.appendChild(title);
        header.appendChild(meta);
        header.appendChild(right);

        const bodyWrap = document.createElement("div");
        bodyWrap.className = "mt-3 grid gap-3";

        const remark = document.createElement("textarea");
        remark.className = "w-full rounded-lg border border-black/10 p-2 text-sm bg-white/80";
        remark.value = task.remark;
        remark.placeholder = "å¤‡æ³¨æ ";
        remark.disabled = task.done;
        remark.oninput = () => task.remark = remark.value;

        const review = document.createElement("textarea");
        review.className = "w-full rounded-lg border border-black/10 p-2 text-sm bg-white/80";
        review.value = task.review;
        review.placeholder = "å¤ç›˜æ ";
        review.disabled = !task.done;
        review.oninput = () => {
          task.review = review.value;
          renderJournal();
          renderCalendar();
        };

        bodyWrap.appendChild(remark);
        bodyWrap.appendChild(review);

        card.appendChild(header);
        card.appendChild(bodyWrap);
        body.appendChild(card);

        if (idx < tasks.length - 1) {
          const next = tasks[idx + 1];
          const intervalDays = Math.max(0, Math.round((new Date(next.deadline) - new Date(task.deadline)) / 86400000));
          const gap = document.createElement("div");
          gap.className = "text-center text-xs text-black/50 cursor-pointer py-2";
          gap.textContent = `${intervalDays} å¤©æ•°é—´éš” Â· ç‚¹å‡»åœ¨æ­¤æ·»åŠ ä»»åŠ¡`;
          gap.onclick = () => {
            const title = prompt("ç›®æ ‡åç§°");
            if (!title) return;
            const suggestion = task.deadline;
            const deadline = prompt("æˆªæ­¢æ—¥æœŸ (YYYY-MM-DD)", suggestion);
            if (!deadline) return;
            getProject().tasks.push({
              id: "t" + Math.random().toString(36).slice(2, 8),
              title,
              deadline,
              remark: "",
              review: "",
              quote: "æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½ç®—æ•°",
              done: false
            });
            renderAll();
          };
          body.appendChild(gap);
        }
      });
    }

    function addTask() {
      const title = prompt("ç›®æ ‡åç§°");
      if (!title) return;
      const deadline = prompt("æˆªæ­¢æ—¥æœŸ (YYYY-MM-DD)", todayISO());
      if (!deadline) return;
      getProject().tasks.push({
        id: "t" + Math.random().toString(36).slice(2, 8),
        title,
        deadline,
        remark: "",
        review: "",
        quote: "æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½ç®—æ•°",
        done: false
      });
      renderAll();
    }

    function renderCalendar() {
      const grid = $("#calGrid");
      grid.innerHTML = "";
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth() + state.monthOffset, 1);
      const year = base.getFullYear();
      const month = base.getMonth();
      $("#calTitle").textContent = `${base.toLocaleString("zh-CN", { month: "long" })} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const totalCells = firstDay + daysInMonth;

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "rounded-lg bg-[#F9F9F9] min-h-[92px] p-2 relative";
        if (i >= firstDay) {
          const day = i - firstDay + 1;
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

          const dayEl = document.createElement("div");
          dayEl.className = "text-xs text-black/60";
          dayEl.textContent = day;
          cell.appendChild(dayEl);

          if (dateStr === todayISO()) {
            cell.style.outline = "2px solid var(--blue)";
          }

          const dots = document.createElement("div");
          dots.className = "flex flex-wrap gap-2 mt-3";
          const tasks = getProject().tasks.filter(t => t.deadline === dateStr);
          tasks.forEach(t => {
            const dot = document.createElement("span");
            dot.className = "cal-dot";
            dot.style.background = statusColor(t);
            dots.appendChild(dot);
          });
          cell.appendChild(dots);
        }
        grid.appendChild(cell);
      }
    }

    function renderJournal() {
      const grid = $("#journalGrid");
      grid.innerHTML = "";
      const tasks = sortTasks(getProject().tasks).filter(t => t.review);
      if (tasks.length === 0) {
        grid.innerHTML = '<div class="text-sm text-black/50">æš‚æ— å¤ç›˜å†…å®¹ã€‚</div>';
        return;
      }

      tasks.forEach(t => {
        // å¤ç›˜å¡ç‰‡
        const card = document.createElement("div");
        card.className = "journal-card";

        const header = document.createElement("div");
        header.className = "flex items-start justify-between gap-4";

        const title = document.createElement("div");
        title.className = "text-lg font-semibold journal-hand";
        title.textContent = t.title;

        const dateBadge = document.createElement("div");
        dateBadge.className = "date-badge";
        dateBadge.textContent = t.deadline.split("-").slice(1).join("/");

        header.appendChild(title);
        header.appendChild(dateBadge);

        const meta = document.createElement("div");
        meta.className = "text-xs text-black/60 mt-1";
        meta.textContent = `æ—¥æœŸï¼š${t.deadline}`;

        const reviewWrap = document.createElement("div");
        reviewWrap.className = "ornate-frame mt-3";

        const review = document.createElement("p");
        review.className = "text-sm leading-relaxed relative z-10";
        review.textContent = t.review;

        reviewWrap.appendChild(review);

        const quoteWrap = document.createElement("div");
        quoteWrap.className = "mt-4";

        const line = document.createElement("div");
        line.className = "doodle-line";

        const quote = document.createElement("div");
        quote.className = "mt-2 text-xs journal-hand quote-editable";
        quote.textContent = t.quote || "æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½ç®—æ•°";
        makeEditable(quote, () => t.quote || "æ¯ä¸€å¤©çš„åŠªåŠ›éƒ½ç®—æ•°", (value) => t.quote = value, "click");

        quoteWrap.appendChild(line);
        quoteWrap.appendChild(quote);

        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(reviewWrap);
        card.appendChild(quoteWrap);

        grid.appendChild(card);
      });
    }

    function renderAll() {
      renderProjects();
      renderTimeline();
      renderCalendar();
      renderJournal();
      saveState();
    }

    // æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p => p.classList.add("hidden"));
        btn.classList.add("active");
        $("#" + btn.dataset.tab).classList.remove("hidden");
        state.currentTab = btn.dataset.tab;
      };
    });

    // æ–°å¢é¡¹ç›®
    $("#addProjectBtn").onclick = () => {
      const name = prompt("é¡¹ç›®åç§°");
      if (!name) return;
      state.projects.push({ id: "p" + Math.random().toString(36).slice(2, 8), name, tasks: [] });
      state.currentProjectId = state.projects[state.projects.length - 1].id;
      renderAll();
    };

    // èƒŒæ™¯é¢æ¿é€»è¾‘
    const bgToggle = $("#bgToggle");
    const bgPanel = $("#bgPanel");
    bgToggle.onclick = () => {
      bgPanel.classList.toggle("show");
    };

    document.addEventListener("click", (e) => {
      if (!bgPanel.contains(e.target) && e.target !== bgToggle) {
        bgPanel.classList.remove("show");
      }
    });

    document.querySelectorAll(".bg-swatch").forEach(btn => {
      btn.onclick = () => {
        const value = btn.dataset.value;
        applyBackground(value);
      };
    });

    $("#bgArt").onclick = () => {
      const art = "radial-gradient(260px 200px at 20% 20%, rgba(173, 196, 212, 0.45), transparent 70%)," +
                  "radial-gradient(240px 210px at 80% 15%, rgba(223, 214, 219, 0.45), transparent 72%)," +
                  "radial-gradient(300px 240px at 30% 80%, rgba(219, 202, 181, 0.45), transparent 75%)," +
                  "radial-gradient(260px 220px at 80% 80%, rgba(193, 210, 193, 0.4), transparent 70%)," +
                  "#F7F5F2";
      applyBackground(art);
    };

    $("#bgFile").onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const value = `url('${reader.result}') center/cover no-repeat fixed`;
        applyBackground(value);
      };
      reader.readAsDataURL(file);
    };

    // ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
    $("#menuToggle").onclick = () => {
      $("#sidebar").classList.add("open");
      $("#overlay").classList.add("show");
    };

    $("#overlay").onclick = closeSidebar;

    // æ–°å¢ä»»åŠ¡
    $("#addTaskBtn").onclick = addTask;
    // æœˆä»½åˆ‡æ¢
    $("#prevMonth").onclick = () => { state.monthOffset--; renderCalendar(); };
    $("#nextMonth").onclick = () => { state.monthOffset++; renderCalendar(); };

    loadState();
    loadBackground();
    renderAll();
  </script>
</body>
</html>
